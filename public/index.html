<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ðŸ‘‹ Random Comments</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://momentjs.com/downloads/moment.min.js"></script>
  </head>
  <body class="bg-white text-black antialiased">
    <div class="max-w-3xl mx-auto px-4 py-16">
      <h1 class="font-bold text-lg">Discussion</h1>

      <p
        id="error-message"
        role="alert"
        class="hidden mt-1 text-red-500 font-medium"
      >
        An error occured whilst processing your request.
      </p>

      <div class="divide-y divide-[#E5E5E5]">
        <form id="comment-form" action="/api/comments" method="POST">
          <input type="hidden" name="name" value="Bob Dylan" />
          <input
            type="hidden"
            name="avatarURL"
            value="https://www.gravatar.com/avatar/?d=mp"
          />

          <div class="flex items-center pt-8 pb-11 text-xs">
            <img class="hidden mr-3 h-9 w-9 rounded-full" />
            <input
              type="text"
              name="content"
              placeholder="What are your thoughts?"
              class="flex-grow py-2 px-3 font-medium border-[1px] border-[#E5E5E5] rounded-[4px] placeholder-[#8A8F9C]"
            />
            <button
              class="ml-3 py-2 px-4 bg-[#7E34F6] text-white font-bold rounded-[4px]"
            >
              Comment
            </button>
          </div>
        </form>

        <div id="comments" class="py-10 space-y-8 text-[#21293C]"></div>
      </div>
    </div>
  </body>
</html>
<script>
  window.addEventListener("DOMContentLoaded", () => {
    generateFakeProfile();
    checkForErrors();
    fetchComments();
  });

  const generateFakeProfile = async () => {
    const response = await fetch("https://randomuser.me/api/");
    if (response.status !== 200) {
      return;
    }
    const { results } = await response.json();
    const { name, picture } = results[0];

    document.querySelector(
      "#comment-form input[name='name']"
    ).value = `${name.first} ${name.last}`;
    document.querySelector("#comment-form input[name='avatarURL']").value =
      picture.thumbnail;

    const image = document.querySelector("#comment-form img");
    image.classList.remove("hidden");
    image.src = picture.medium;
  };

  const checkForErrors = () => {
    const params = new Proxy(new URLSearchParams(window.location.search), {
      get: (searchParams, prop) => searchParams.get(prop),
    });
    let error = params.error;
    if (error) {
      document.querySelector("#error-message").classList.remove("hidden");
    }
  };

  const fetchComments = async () => {
    const response = await fetch("/api/comments");
    if (response.status !== 200) {
      throw Error(response.statusText);
    }
    const comments = await response.json();
    comments.map(function (comment) {
      document.querySelector("#comments").insertAdjacentHTML(
        "beforeend",
        `<article class="ml-4 flex items-start">
          <img src="${
            comment.avatarURL
              ? comment.avatarURL
              : "https://www.gravatar.com/avatar/?d=mp"
          }" class="h-9 w-9 rounded-full" style="transform: translate(calc(-50%), var(--tw-translate-y));"/>
          <div class="-ml-1">
            <div class="flex items-center space-x-2">
              <span class="text-sm font-semibold">${
                comment.name ? comment.name : "Anonymous"
              }</span>
              <span class="text-xs text-[#4B587C]">
                &bull;
              </span>
              <span class="text-xs text-[#4B587C]">${
                comment.createdAt
                  ? moment(comment.createdAt).fromNow()
                  : "Unknown time"
              }</span>
            </div>
            <p class="mt-1 text-sm">${
              comment.content ? comment.content : "Nothing to see here ðŸ‘€"
            }</p>
            <div class="mt-4 flex items-center font-semibold text-xs text-[#4B587C]">
              <form action="/api/comments/${comment.id}" method="POST">
                <button class="flex items-center hover:text-black">
                  <span class="text-[8px]">â–²</span>
                  <span class="ml-2">${
                    comment.upvotes ? comment.upvotes : 0
                  }</span>
                  <span class="ml-1">Upvotes<span>
                </button>
              </form>
            </div>
          </div>
        </article>`
      );
    });
  };
</script>
</html>
